<!DOCTYPE html>
<html lang="sl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>3D Naročila</title>
<style>
  body { background: #121212; color: #eee; font-family: sans-serif; padding: 20px;}
  .container { max-width: 800px; margin: auto; background: #222; padding: 20px; border-radius: 10px;}
  input, button, select { width: 100%; margin: 8px 0; padding: 10px; border-radius: 5px; border: none; }
  button { background: #00cccc; color: black; font-weight: bold; cursor: pointer; }
  button:hover { background: #00ffff; }
  table { width: 100%; border-collapse: collapse; margin-top: 10px; }
  th, td { border: 1px solid #444; padding: 8px; text-align: center; }
  th { background: #00cccc; }
  #loginSection, #appSection { display: none; }
</style>
<script src="https://cdn.emailjs.com/dist/email.min.js"></script>
</head>
<body>

<div class="container">

  <div id="loginSection">
    <h2>Prijava</h2>
    <input id="username" placeholder="Uporabniško ime" />
    <input id="password" type="password" placeholder="Geslo" />
    <button id="loginBtn">Prijavi se</button>
    <p id="loginMsg" style="color: red;"></p>
  </div>

  <div id="appSection">
    <h1>3D Naročila</h1>
    <form id="orderForm">
      <input type="text" id="ime" placeholder="Ime" required />
      <input type="text" id="priimek" placeholder="Priimek" required />
      <input type="email" id="email" placeholder="Email" required />
      <input type="tel" id="telefon" placeholder="Telefon" required />
      <input type="text" id="stIzdelka" placeholder="Št. izdelka" required />
      <input type="text" id="imeIzdelka" placeholder="Ime izdelka" required />
      <input type="number" id="kolicina" placeholder="Količina" min="1" required />
      <select id="sodelavec" required>
        <option value="" disabled selected>Izberi sodelavca</option>
        <option value="sodelavec1@example.com">Sodelavec 1</option>
        <option value="sodelavec2@example.com">Sodelavec 2</option>
        <option value="sodelavec3@example.com">Sodelavec 3</option>
      </select>
      <button type="submit">Dodaj naročilo</button>
    </form>

    <table>
      <thead>
        <tr>
          <th>#</th><th>Ime</th><th>Priimek</th><th>Email</th><th>Telefon</th>
          <th>Št. izdelka</th><th>Ime izdelka</th><th>Količina</th>>
        </tr>
      </thead>
      <tbody id="ordersTableBody"></tbody>
    </table>

    <button id="logoutBtn" style="margin-top:20px;">Odjava</button>
  </div>

</div>

<script>
  // Inicializiraj EmailJS
  (function(){
    emailjs.init("WnsQ-mdOuOtf2gtxc"); // Tukaj vstavi svoj user ID iz EmailJS
  })();

  // --- Prijava ---
  const loginSection = document.getElementById('loginSection');
  const appSection = document.getElementById('appSection');
  const loginBtn = document.getElementById('loginBtn');
  const loginMsg = document.getElementById('loginMsg');

  const users = {
    "aljaz": "loveme",
    "admin": "admin123"
  };

  function showApp() {
    loginSection.style.display = 'none';
    appSection.style.display = 'block';
  }
  function showLogin() {
    loginSection.style.display = 'block';
    appSection.style.display = 'none';
  }

  if(localStorage.getItem('loggedIn') === 'true') {
    showApp();
  } else {
    showLogin();
  }

  loginBtn.onclick = () => {
    const user = document.getElementById('username').value.trim();
    const pass = document.getElementById('password').value;
    if(users[user] && users[user] === pass) {
      localStorage.setItem('loggedIn', 'true');
      showApp();
      loginMsg.textContent = '';
    } else {
      loginMsg.textContent = "Napačno uporabniško ime ali geslo";
    }
  };

  document.getElementById('logoutBtn').onclick = () => {
    localStorage.removeItem('loggedIn');
    showLogin();
  };

  // --- IndexedDB ---
  let db;
  const req = indexedDB.open("3dNarocilaDB", 1);
  req.onupgradeneeded = e => {
    db = e.target.result;
    if(!db.objectStoreNames.contains("narocila")) {
      db.createObjectStore("narocila", { keyPath: "id", autoIncrement: true });
    }
  };
  req.onsuccess = e => {
    db = e.target.result;
    loadOrders();
  };
  req.onerror = e => console.error("Napaka IndexedDB:", e);

  const form = document.getElementById('orderForm');
  const tbody = document.getElementById('ordersTableBody');

  form.addEventListener('submit', e => {
    e.preventDefault();

    const naročilo = {
      ime: form.ime.value.trim(),
      priimek: form.priimek.value.trim(),
      email: form.email.value.trim(),
      telefon: form.telefon.value.trim(),
      stIzdelka: form.stIzdelka.value.trim(),
      imeIzdelka: form.imeIzdelka.value.trim(),
      kolicina: parseInt(form.kolicina.value),
      sodelavec: form.sodelavec.value
    };

    // Shrani naročilo v IndexedDB
    const tx = db.transaction("narocila", "readwrite");
    tx.objectStore("narocila").add(naročilo);
    tx.oncomplete = () => {
      loadOrders();
      alert("Naročilo dodano!");
      form.reset();

      // Pošlji email sodelavcu z naročilom
      sendEmail(naročilo);
    };
    tx.onerror = () => alert("Napaka pri shranjevanju naročila!");
  });

  function loadOrders() {
    const tx = db.transaction("narocila", "readonly");
    const store = tx.objectStore("narocila");
    const req = store.getAll();
    req.onsuccess = () => {
      tbody.innerHTML = "";
      req.result.forEach((n, i) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${i+1}</td><td>${n.ime}</td><td>${n.priimek}</td><td>${n.email}</td><td>${n.telefon}</td>
          <td>${n.stIzdelka}</td><td>${n.imeIzdelka}</td><td>${n.kolicina}</td><td>${n.sodelavec}</td>
        `;
        tbody.appendChild(tr);
      });
    };
  }

  function sendEmail(order) {
    const templateParams = {
      ime: order.ime,
      priimek: order.priimek,
      email: order.email,
      telefon: order.telefon,
      stIzdelka: order.stIzdelka,
      imeIzdelka: order.imeIzdelka,
      kolicina: order.kolicina,
      sodelavec_email: order.sodelavec
    };

    emailjs.send('narocila.3d', 'template_a6h5vjp', templateParams)
    .then(function(response) {
       console.log('Email uspešno poslan!', response.status, response.text);
    }, function(error) {
       console.error('Napaka pri pošiljanju emaila:', error);
    });
  }
</script>

</body>
</html>

